import React, { Component } from "react";

export default class FactList extends Component {
    state = {
        editing: null
    }

    toggleEditing = (itemId) => {
        this.setState((prevState, props) => { prevState.editing = itemId })
    }

    removeItem = item => {
        this.props.removeItem(item);
    }

    handleEditField = event => {
        if (event.keyCode === 13) {
            const target = event.target;
            let update = {};

            update._id = this.state.editing;
            update[target.name] = target.value;

            this.handleUpdate(update);
        }
    }

    handleEditItem = () => {
        let itemId = this.state.editing;

        this.handleUpdate({
            _id: itemId,
            label: this.refs[`label_${itemId}`].value,
            fact: this.refs[`fact_${itemId}`].value,
        });
    }

    handleUpdate = (update) => {
        this.props.updateItem(update);
        this.setState((prevState, props) => { prevState.editing = null })
    }

    renderItemOrEdit = item => {
        if(this.state.editing === item._id) {
            return (<tr key={`editing-${item._id}`}>
                <td>
                    <input
                        onKeyDown={(event) => this.handleEditField(event)}
                        type="text"
                        className="form-control"
                        ref={`label_${item._id}`}
                        name="label"
                        defaultValue={item.label}
                    />
                </td>
                <td>
                    <input
                        onKeyDown={(event) => this.handleEditField(event)}
                        type="text"
                        className="form-control"
                        ref={`fact_${item._id}`}
                        name="fact"
                        defaultValue={item.fact}
                    />
                </td>
                <td>
                    <button
                        className="btn btn-default"
                        onClick={() => this.handleEditItem()}
                    >Update</button>
                </td>
            </tr>);
        } else { 
            return (
                <tr
                    key={item._id}
                    onClick={() => this.toggleEditing(item._id)}
                >
                <td>{item.label}</td>
                <td>{item.fact}</td>
                <td>
                    <button
                        className="btn btn-default"
                        onClick={() => this.removeItem(item)}
                    >remove</button>
                </td>
            </tr>);
        }
    }

    render() { 
        const { data } = this.props;

        return(
            <table className="table">
                <thead>
                    <tr>
                        <td>Label</td>
                        <td>Fact</td>
                        <td className="width-15"></td>
                    </tr>
                </thead>
                <tbody>
                    {data.map(item => { return this.renderItemOrEdit(item); })}
                </tbody>
            </table>
        );
    }
}